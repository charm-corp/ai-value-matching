#!/usr/bin/env node\n\n/**\n * RLS + Backend Integration Test\n * ìš°ë¦¬ì˜ ìƒˆë¡œìš´ RLS ì‹œìŠ¤í…œì´ ì˜¬ë°”ë¥´ê²Œ í†µí•©ë˜ì—ˆëŠ”ì§€ í…ŒìŠ¤íŠ¸\n */\n\nconst path = require('path');\nrequire('dotenv').config();\n\n// í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •\nprocess.env.NODE_ENV = 'test';\nprocess.env.MONGODB_URI = 'mongodb://localhost:27017/charm-inyeon-test';\nprocess.env.PORT = '3001';\n\nconsole.log('ğŸ§ª RLS + Backend Integration Test Starting...');\nconsole.log('=' .repeat(50));\n\n// 1. ê¸°ë³¸ ì˜ì¡´ì„± í…ŒìŠ¤íŠ¸\nconsole.log('1ï¸âƒ£ Testing basic dependencies...');\ntry {\n  const mongoose = require('mongoose');\n  const express = require('express');\n  console.log('âœ… Core dependencies loaded');\n} catch (error) {\n  console.error('âŒ Core dependency error:', error.message);\n  process.exit(1);\n}\n\n// 2. ìƒˆë¡œìš´ RLS ì‹œìŠ¤í…œ ì˜ì¡´ì„± í…ŒìŠ¤íŠ¸\nconsole.log('\\n2ï¸âƒ£ Testing RLS system dependencies...');\ntry {\n  const { integrateRLSSystem } = require('./middleware/rlsIntegration');\n  const { getCacheService } = require('./services/cacheService');\n  const { getPerformanceService } = require('./services/performanceService');\n  const { getHealthCheckService } = require('./monitoring/healthCheck');\n  console.log('âœ… RLS system dependencies loaded');\n} catch (error) {\n  console.error('âŒ RLS dependency error:', error.message);\n  console.log('ğŸ“ Error details:', error.stack);\n}\n\n// 3. ì„œë¹„ìŠ¤ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸\nconsole.log('\\n3ï¸âƒ£ Testing service initialization...');\ntry {\n  const { getCacheService } = require('./services/cacheService');\n  const cacheService = getCacheService();\n  console.log('âœ… Cache service initialized');\n  \n  const { getPerformanceService } = require('./services/performanceService');\n  const perfService = getPerformanceService();\n  console.log('âœ… Performance service initialized');\n  \n  const { getHealthCheckService } = require('./monitoring/healthCheck');\n  const healthService = getHealthCheckService();\n  console.log('âœ… Health check service initialized');\n} catch (error) {\n  console.error('âŒ Service initialization error:', error.message);\n}\n\n// 4. Express ì•± ìƒì„± ë° RLS í†µí•© í…ŒìŠ¤íŠ¸\nconsole.log('\\n4ï¸âƒ£ Testing Express app with RLS integration...');\ntry {\n  const express = require('express');\n  const { integrateRLSSystem, createCompatibilityMiddleware } = require('./middleware/rlsIntegration');\n  \n  const testApp = express();\n  \n  // ê¸°ë³¸ ë¯¸ë“¤ì›¨ì–´\n  testApp.use(express.json());\n  testApp.use(createCompatibilityMiddleware());\n  \n  // í…ŒìŠ¤íŠ¸ ë¼ìš°íŠ¸\n  testApp.get('/test', (req, res) => {\n    res.json({\n      success: true,\n      message: 'RLS integration test successful',\n      rlsContext: req.rlsContext ? 'present' : 'not present',\n      timestamp: new Date().toISOString()\n    });\n  });\n  \n  console.log('âœ… Express app with RLS compatibility created');\n  \n  // RLS ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸\n  integrateRLSSystem(testApp)\n    .then(success => {\n      if (success) {\n        console.log('âœ… RLS system integration successful');\n        \n        // í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹œì‘\n        const server = testApp.listen(3001, () => {\n          console.log('âœ… Test server started on port 3001');\n          \n          // ê°„ë‹¨í•œ HTTP ìš”ì²­ í…ŒìŠ¤íŠ¸\n          const http = require('http');\n          const options = {\n            hostname: 'localhost',\n            port: 3001,\n            path: '/test',\n            method: 'GET'\n          };\n          \n          const req = http.request(options, (res) => {\n            let data = '';\n            res.on('data', (chunk) => {\n              data += chunk;\n            });\n            res.on('end', () => {\n              try {\n                const response = JSON.parse(data);\n                console.log('âœ… HTTP test successful:', response.message);\n                console.log('\\nğŸ‰ ALL TESTS PASSED!');\n                console.log('ğŸ“Š Integration Summary:');\n                console.log('   - Core dependencies: âœ…');\n                console.log('   - RLS dependencies: âœ…');\n                console.log('   - Service initialization: âœ…');\n                console.log('   - Express integration: âœ…');\n                console.log('   - HTTP endpoint: âœ…');\n                \n                server.close();\n                process.exit(0);\n              } catch (error) {\n                console.error('âŒ HTTP response parsing error:', error.message);\n                server.close();\n                process.exit(1);\n              }\n            });\n          });\n          \n          req.on('error', (error) => {\n            console.error('âŒ HTTP request error:', error.message);\n            server.close();\n            process.exit(1);\n          });\n          \n          req.end();\n        });\n        \n        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)\n        setTimeout(() => {\n          console.log('â° Test timeout reached');\n          server.close();\n          process.exit(0);\n        }, 30000);\n        \n      } else {\n        console.warn('âš ï¸ RLS system integration had issues');\n        process.exit(1);\n      }\n    })\n    .catch(error => {\n      console.error('âŒ RLS integration error:', error.message);\n      process.exit(1);\n    });\n  \n} catch (error) {\n  console.error('âŒ Express app creation error:', error.message);\n  console.log('ğŸ“ Error stack:', error.stack);\n  process.exit(1);\n}\n\n// ì˜ˆì™¸ ì²˜ë¦¬\nprocess.on('uncaughtException', (error) => {\n  console.error('âŒ Uncaught exception:', error.message);\n  process.exit(1);\n});\n\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.error('âŒ Unhandled rejection:', reason);\n  process.exit(1);\n});"